# Copyright (c) 2025 Joe Walter
# GNU General Public License v3.0

import os
import unittest
import logging

from psync import core, filter, helpers, sftp, watch

logger = logging.getLogger("psync.tests")

class TestFilter(unittest.TestCase):

	def test_filter(self):
		root = ""

		f = filter.PathFilter(r"+ **")
		self.assertTrue(f.filter(root, "a"))
		self.assertTrue(f.filter(root, "a/b"))
		self.assertTrue(f.filter(root, "a/b/c"))
		self.assertTrue(f.filter(root, ".git/"))
		self.assertTrue(f.filter(root, "a/.git/"))
		self.assertTrue(f.filter(root, "a/b/.git/"))
		self.assertTrue(f.filter(root, "__pycache__/"))
		self.assertTrue(f.filter(root, "a/__pycache__/"))
		self.assertTrue(f.filter(root, "a/b/__pycache__/"))

		f = filter.PathFilter(r"+ **/*")
		self.assertTrue(f.filter(root, "a"))
		self.assertTrue(f.filter(root, "a/b"))
		self.assertTrue(f.filter(root, "a/b/c"))
		self.assertTrue(f.filter(root, ".git/"))
		self.assertTrue(f.filter(root, "a/.git/"))
		self.assertTrue(f.filter(root, "a/b/.git/"))
		self.assertTrue(f.filter(root, "__pycache__/"))
		self.assertTrue(f.filter(root, "a/__pycache__/"))
		self.assertTrue(f.filter(root, "a/b/__pycache__/"))

		f = filter.PathFilter(r"- **/.*/ **/__pycache__/ + **/*/ **/*")
		self.assertTrue(f.filter(root, "a"))
		self.assertTrue(f.filter(root, "a/b"))
		self.assertTrue(f.filter(root, "a/b/c"))
		self.assertFalse(f.filter(root, ".git/"))
		self.assertFalse(f.filter(root, "a/.git/"))
		self.assertFalse(f.filter(root, "a/b/.git/"))
		self.assertFalse(f.filter(root, "__pycache__/"))
		self.assertFalse(f.filter(root, "a/__pycache__/"))
		self.assertFalse(f.filter(root, "a/b/__pycache__/"))

		f = filter.PathFilter(r"+ audio/music/**/*.flac - **/*/ **/*")
		self.assertTrue(f.filter(root, "audio/"))
		self.assertTrue(f.filter(root, "audio/music/"))
		self.assertTrue(f.filter(root, "audio/music/OST/"))
		self.assertTrue(f.filter(root, "audio/music/OST/Star Wars/"))
		self.assertTrue(f.filter(root, "audio/music/OST/Star Wars/Duel of the Fates.flac"))
		self.assertFalse(f.filter(root, "video/"))
		self.assertFalse(f.filter(root, "audio/audiobooks/"))
		self.assertFalse(f.filter(root, "audio/music/OST/Star Wars/cover.jpg"))

		f = filter.PathFilter(r"- audio/music/**/*.wav + audio/music/**")
		self.assertTrue(f.filter(root, "audio/"))
		self.assertTrue(f.filter(root, "audio/music/"))
		self.assertTrue(f.filter(root, "audio/music/OST/"))
		self.assertTrue(f.filter(root, "audio/music/OST/Titanic/"))
		self.assertTrue(f.filter(root, "audio/music/OST/Titanic/cover.jpg"))
		self.assertFalse(f.filter(root, "audio/music/OST/Titanic/My Heart Will Go On (Recorder Cover).wav"))
		self.assertFalse(f.filter(root, "video/"))
		self.assertFalse(f.filter(root, "audio/audiobooks/"))

		f = filter.PathFilter(r"places.sqlite key4.db logins.json cookies.sqlite prefs.js")
		self.assertTrue(f.filter(root, "places.sqlite"))
		self.assertTrue(f.filter(root, "key4.db"))
		self.assertTrue(f.filter(root, "logins.json"))
		self.assertTrue(f.filter(root, "cookies.sqlite"))
		self.assertTrue(f.filter(root, "prefs.js"))
		self.assertFalse(f.filter(root, "storage.sqlite"))
		self.assertFalse(f.filter(root, "storage/"))

		f = filter.PathFilter("'**/a b' \"**/A B\" **/'x y'  Joe\\'s\\ File")
		self.assertTrue(f.filter(root, "**/a b"))
		self.assertFalse(f.filter(root, "a b"))
		self.assertFalse(f.filter(root, "1/2/a b"))
		self.assertTrue(f.filter(root, "A B"))
		self.assertTrue(f.filter(root, "1/2/A B"))
		self.assertTrue(f.filter(root, "x y"))
		self.assertTrue(f.filter(root, "1/2/x y"))
		self.assertTrue(f.filter(root, "Joe's File"))
		self.assertFalse(f.filter(root, "a"))

		f = filter.PathFilter("\"'a'\"   '\"b\"'   \"x ?\"'y ?' ")
		self.assertTrue(f.filter(root, "'a'"))
		self.assertTrue(f.filter(root, "\"b\""))
		self.assertTrue(f.filter(root, "x 1y ?"))
		self.assertFalse(f.filter(root, "x 1y 2"))

		f = filter.PathFilter(r"+ * - a/ b/a/ + b/*/ - **/x + ?/**/* - **/*")
		self.assertTrue(f.filter(root, "a"))
		self.assertTrue(f.filter(root, "b/a"))
		self.assertTrue(f.filter(root, "b/a/a"))
		self.assertTrue(f.filter(root, "b/b/"))
		self.assertFalse(f.filter(root, "a/"))
		self.assertFalse(f.filter(root, "b/a/"))
		self.assertFalse(f.filter(root, "b/b/x"))
		self.assertTrue(f.filter(root, "b/y"))
		self.assertTrue(f.filter(root, "b/b/y"))
		self.assertFalse(f.filter(root, "aa/y"))

		f = filter.PathFilter(r"+ a B - A b c + **/*", ignore_hidden=True, ignore_case=True)
		self.assertTrue(f.filter(root, "a"))
		self.assertTrue(f.filter(root, "A"))
		self.assertTrue(f.filter(root, "b"))
		self.assertTrue(f.filter(root, "B"))
		self.assertFalse(f.filter(root, "c"))
		self.assertFalse(f.filter(root, "C"))
		self.assertFalse(f.filter(root, ".a"))
		self.assertFalse(f.filter(root, ".A"))
		self.assertFalse(f.filter(root, "d/.a"))
		self.assertFalse(f.filter(root, "d/.A"))

		f = filter.PathFilter(r"./a/ ./a/b")
		self.assertTrue(f.filter(root, "a/"))
		self.assertTrue(f.filter(root, "a/b"))
		self.assertFalse(f.filter(root, "c"))

		f = filter.PathFilter(r"a/ a/b")
		if os.sep == "\\":
			self.assertTrue(f.filter(root, "a/"))
			self.assertTrue(f.filter(root, "a\\"))
			self.assertTrue(f.filter(root, "a/b"))
			self.assertTrue(f.filter(root, "a\\b"))
			self.assertFalse(f.filter(root, "c"))
		else:
			self.assertTrue(f.filter(root, "a/"))
			self.assertFalse(f.filter(root, "a\\"))
			self.assertTrue(f.filter(root, "a/b"))
			self.assertFalse(f.filter(root, "a\\b"))
			self.assertFalse(f.filter(root, "c"))

		f = filter.PathFilter(r"a\\ a\b")
		if os.sep == "\\":
			self.assertTrue(f.filter(root, "a/"))
			self.assertTrue(f.filter(root, "a\\"))
			self.assertTrue(f.filter(root, "a/b"))
			self.assertTrue(f.filter(root, "a\\b"))
			self.assertFalse(f.filter(root, "c"))
		else:
			self.assertFalse(f.filter(root, "a/"))
			self.assertTrue(f.filter(root, "a\\"))
			self.assertFalse(f.filter(root, "a/b"))
			self.assertTrue(f.filter(root, "a\\b"))
			self.assertFalse(f.filter(root, "c"))

		f = filter.PathFilter(r"'- a' -a -- a\  a\ - ./- \"a a\'b")
		self.assertTrue(f.filter(root, "- a"))
		self.assertTrue(f.filter(root, "-a"))
		self.assertTrue(f.filter(root, "--"))
		self.assertTrue(f.filter(root, "a "))
		self.assertTrue(f.filter(root, "a -"))
		self.assertTrue(f.filter(root, "-"))
		self.assertTrue(f.filter(root, "\"a"))
		self.assertTrue(f.filter(root, "a'b"))
		self.assertFalse(f.filter(root, "b"))

		f = filter.PathFilter(r"'-'")
		self.assertTrue(f.filter(root, "-"))
		self.assertFalse(f.filter(root, "a"))

		f = filter.PathFilter("\"-\"")
		self.assertTrue(f.filter(root, "-"))
		self.assertFalse(f.filter(root, "a"))

		self.assertRaises(ValueError, filter.PathFilter, r"+ \-")
		self.assertRaises(ValueError, filter.PathFilter, r"+ 'a")
		self.assertRaises(ValueError, filter.PathFilter,  "+ a\\")
		self.assertRaises(ValueError, filter.PathFilter,  "+ /a")

		if os.sep == "\\":
			self.assertRaises(ValueError, filter.PathFilter,  "+ \\/a")
			self.assertRaises(ValueError, filter.PathFilter,  "+ \\\\a")

		f = filter.PathFilter("a/ b/ ./1 c/ c/d/ ./2")
		self.assertFalse(f.filter(root, "1"))
		self.assertTrue(f.filter(root, "a/1"))
		self.assertTrue(f.filter(root, "b/1"))
		self.assertTrue(f.filter(root, "a/2"))
		self.assertTrue(f.filter(root, "b/2"))
		self.assertFalse(f.filter(root, "c/1"))
		self.assertTrue(f.filter(root, "a/2"))
		self.assertTrue(f.filter(root, "b/2"))
		self.assertTrue(f.filter(root, "c/2"))
		self.assertFalse(f.filter(root, "c/3"))
		self.assertTrue(f.filter(root, "c/d/2"))
		self.assertFalse(f.filter(root, "d/2"))

		f = filter.PathFilter("a/ - b/ + c/ d ./1 + e/ ./**/*")
		self.assertFalse(f.filter(root, "a/1"))
		self.assertFalse(f.filter(root, "b/1"))
		self.assertTrue(f.filter(root, "c/1"))
		self.assertFalse(f.filter(root, "d/1"))
		self.assertTrue(f.filter(root, "e/e/e/1"))

		f = filter.PathFilter("a/b/ ./1")
		self.assertFalse(f.filter(root, "a/1"))
		self.assertFalse(f.filter(root, "b/1"))
		self.assertTrue(f.filter(root, "a/b/1"))